<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Profile | CollegeFinder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/home.css">
</head>

<body>

<header class="site-header solid">
  <div class="wrap header-row">
    <div class="brand-text">CollegeFinder</div>

    <nav class="nav">
      <a href="index.html" class="nav-link">Home</a>
      <a href="compare.html" class="nav-link">Compare</a>
    </nav>

    <div class="header-actions">
      <!-- profile menu commented as-is -->
    </div>
  </div>
</header>

<main class="profile-container">


  <section class="card" style="padding:30px;text-align:center">
    <img src="assets/images/avatar.png"
         style="width:100px;height:100px;border-radius:50%;border:3px solid #3b82f6">

    <h2 id="userName" style="margin-top:12px">Student</h2>
    <p id="userEmail" class="muted"></p>

    <div style="margin-top:14px">
      <span class="badge">Student Account</span>
    </div>
  </section>

  <section class="card account-overview" style="margin-top:24px">
    <h3 class="section-title">Account Overview</h3>

    <div class="overview-grid">
      <div class="overview-card">
        <div class="overview-icon">‚ù§Ô∏è</div>
        <div class="overview-info">
          <div class="overview-value" id="savedCount">0</div>
          <div class="overview-label">Saved Colleges</div>
        </div>
      </div>

      <div class="overview-card">
        <div class="overview-icon">üìù</div>
        <div class="overview-info">
          <div class="overview-value" id="reviewCount">0</div>
          <div class="overview-label">Reviews Submitted</div>
        </div>
      </div>

      <div class="overview-card">
        <div class="overview-icon">üìä</div>
        <div class="overview-info">
          <div class="overview-value" id="compareCount">0</div>
          <div class="overview-label">Compared Colleges</div>
        </div>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:24px">
    <h3>Saved Colleges</h3>
    <div id="savedColleges" class="results-list"></div>

    <p id="noSavedMsg" class="muted" style="display:none">
      You haven‚Äôt saved any colleges yet.
    </p>
  </section>

  <section class="card" style="margin-top:24px">
    <h3>Your Reviews</h3>
    <div id="userReviews"></div>
  </section>

  <section class="card" style="margin-top:24px">
  <h3>Compared Colleges</h3>

  <div id="comparedColleges" class="results-list"></div>

  <p id="noCompareMsg" class="muted" style="display:none">
    You haven‚Äôt added any colleges for comparison yet.
  </p>

  <div style="margin-top:16px">
    <a href="compare.html" class="btn primary sm">
      View Full Comparison ‚Üí
    </a>
  </div>
</section>

  <section class="card" style="margin-top:24px">
    <h3>Account Actions</h3>

    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:14px">
      <button id="editProfileBtn" class="btn outline">Edit Profile</button>
      <button id="logoutMainBtn" class="btn primary">Logout</button>
    </div>
  </section>

  <!-- EDIT PROFILE MODAL -->
<div id="editProfileModal" class="modal hidden">
  <div class="modal-content">
    <h3>Edit Profile</h3>

    <input id="editName" type="text" placeholder="Full Name">
    <input id="editEmail" type="email" placeholder="Email Address">

    <div class="modal-actions">
      <button id="cancelEditBtn" class="btn outline sm">Cancel</button>
      <button id="saveProfileBtn" class="btn primary sm">Save</button>
    </div>
  </div>
</div>

</main>

<footer class="site-footer">
  <div class="wrap footer-grid">
    <div>¬© <span id="year"></span> CollegeFinder</div>
    <div class="muted small">Helping students make informed decisions</div>
  </div>
</footer>

<script src="assets/js/api.js"></script>


<script>

function authHeaders() {
  const token = localStorage.getItem("cf_token");
  return token ? { Authorization: `Bearer ${token}` } : {};
}

document.getElementById("year").textContent = new Date().getFullYear();

const API_BASE = "http://https://college-finder-fx5r.onrender.com";
const currentUser = JSON.parse(localStorage.getItem("cf_user"));
const token = localStorage.getItem("cf_token");

if (!currentUser || !token) {
  window.location.href = "auth.html";
}

const USER_ID = currentUser.id;

userName.textContent = currentUser.name || "Student";
userEmail.textContent = currentUser.email || "";

/* üîß FIX: define missing elements */
const logoutBtn = document.getElementById("logoutBtn");
const logoutMainBtn = document.getElementById("logoutMainBtn");

/* LOGIN STATE */
const isLoggedIn = localStorage.getItem("cf_logged_in") === "true";

function logout() {
  localStorage.removeItem("cf_logged_in");
  localStorage.removeItem("cf_user");
  localStorage.removeItem("cf_token");
  window.location.href = "index.html";
}

if (logoutBtn) logoutBtn.onclick = logout;
logoutMainBtn.onclick = logout;

/* SAVED COLLEGES */
const savedWrap = document.getElementById("savedColleges");
const noSavedMsg = document.getElementById("noSavedMsg");
const savedCountEl = document.getElementById("savedCount");

async function loadSavedColleges() {
  savedWrap.innerHTML = "";

  const res = await safeFetch(`${API_BASE}/api/users/saved`);
  if (!res.ok) return;

  const saved = await res.json();
  savedCountEl.textContent = saved.length;

  if (!saved.length) {
  noSavedMsg.style.display = "block";
  savedWrap.innerHTML = `
    <div class="empty-box">
      ‚ù§Ô∏è No saved colleges yet.
      <br>
      <a href="index.html" class="btn sm primary" style="margin-top:12px">
        Browse Colleges
      </a>
    </div>
  `;
  return;
}



  noSavedMsg.style.display = "none";

  saved.forEach(col => {
    const div = document.createElement("div");
    div.className = "college-card";
    div.innerHTML = `
      <div class="college-thumb"
        style="background-image:url('${col.image || "assets/images/college-placeholder.png"}')"></div>
      <div style="padding-left:14px">
        <h4>${col.name}</h4>
        <p class="muted">${col.city}, ${col.state}</p>
        <a href="college.html?id=${col.id}" class="btn sm primary">View Details</a>
      </div>
    `;
    savedWrap.appendChild(div);
  });
}

window.addEventListener("saved-updated", loadSavedColleges);
loadSavedColleges();

const compareCountEl = document.getElementById("compareCount");

async function loadCompareCount() {
  const res = await safeFetch(`${API_BASE}/api/users/compare`);

  if (!res.ok) return;

  const data = await res.json();
  compareCountEl.textContent = data.length;
}
window.addEventListener("compare-updated", loadCompareCount);
loadCompareCount();

/* REVIEW COUNT */
const reviewCountEl = document.getElementById("reviewCount");

async function loadReviewCount() {
  const res = await safeFetch(`${API_BASE}/api/users/reviews/count`);
  if (!res.ok) return;

  const data = await res.json();
  reviewCountEl.textContent = data.count;
}


window.addEventListener("reviews-updated", loadReviewCount);
loadReviewCount();

const userReviewsWrap = document.getElementById("userReviews");

async function loadUserReviews() {
  userReviewsWrap.innerHTML = "";

const res = await safeFetch(`${API_BASE}/api/users/reviews`);


  if (!res.ok) {
    userReviewsWrap.innerHTML =
      "<p class='muted'>Unable to load reviews</p>";
    return;
  }

  const reviews = await res.json();

  if (!reviews.length) {
    userReviewsWrap.innerHTML =
      "<p class='muted'>You haven‚Äôt submitted any reviews yet.</p>";
    return;
  }

  reviews.forEach(r => {
    const div = document.createElement("div");
    div.className = "card";
    div.style.marginBottom = "14px";
    div.style.padding = "16px";
    div.style.background = "#ffffff";
    div.style.color = "#0f172a";

    div.innerHTML = `
      <h3 style="margin-bottom:6px;color:#0f172a">
        ${r.college_name}
      </h3>

      <div style="
        display:inline-block;
        background:#fef3c7;
        color:#92400e;
        padding:4px 10px;
        border-radius:8px;
        font-weight:600;
        margin-bottom:8px">
        ‚≠ê ${r.rating} / 5
      </div>

      <p style="color:#334155;margin-top:8px">
        ${r.comment}
      </p>

      <a href="college.html?id=${r.college_id}#reviews"
         class="btn sm primary"
         style="margin-top:10px;display:inline-block">
        Edit Review
      </a>
    `;

    userReviewsWrap.appendChild(div);
  });
}


loadUserReviews();


/* ================= COMPARED COLLEGES ================= */

const comparedWrap = document.getElementById("comparedColleges");
const noCompareMsg = document.getElementById("noCompareMsg");

async function loadComparedColleges() {
  comparedWrap.innerHTML = "";

  const res = await safeFetch(`${API_BASE}/api/users/compare`);
  if (!res.ok) return;

  const compared = await res.json();

  if (!compared.length) {
    noCompareMsg.style.display = "block";
    return;
  }

  noCompareMsg.style.display = "none";

  compared.forEach(col => {
    const div = document.createElement("div");
    div.className = "college-card";

    div.innerHTML = `
      <div class="college-thumb"
        style="background-image:url('${col.image || "assets/images/college-placeholder.png"}')">
      </div>

      <div style="padding-left:14px">
        <h4>${col.name}</h4>
        <p class="muted">${col.city}, ${col.state}</p>
        <a href="college.html?id=${col.id}" class="btn sm primary">
          View Details
        </a>
      </div>
    `;

    comparedWrap.appendChild(div);
  });
}

window.addEventListener("compare-updated", loadComparedColleges);
loadComparedColleges();

/* ================= EDIT PROFILE ================= */

const editBtn = document.getElementById("editProfileBtn");
const modal = document.getElementById("editProfileModal");
const cancelBtn = document.getElementById("cancelEditBtn");
const saveBtnProfile = document.getElementById("saveProfileBtn");

const editName = document.getElementById("editName");
const editEmail = document.getElementById("editEmail");

editBtn.onclick = () => {
  editName.value = currentUser.name;
  editEmail.value = currentUser.email;
  modal.classList.remove("hidden");
};

cancelBtn.onclick = () => {
  modal.classList.add("hidden");
};

saveBtnProfile.onclick = async () => {
  const newName = editName.value.trim();
  const newEmail = editEmail.value.trim();

  if (!newName || !newEmail) {
    alert("All fields are required");
    return;
  }

  const res = await safeFetch(`${API_BASE}/api/users/update-profile`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      ...authHeaders()
    },
    body: JSON.stringify({
      name: newName,
      email: newEmail
    })
  });

  if (!res.ok) {
    alert("Profile update failed");
    return;
  }

  const updatedUser = await res.json();

  // Update localStorage
  localStorage.setItem("cf_user", JSON.stringify(updatedUser));

  // Update UI
  userName.textContent = updatedUser.name;
  userEmail.textContent = updatedUser.email;

  modal.classList.add("hidden");

  alert("Profile updated successfully üéâ");
};
</script>

</body>
</html>
